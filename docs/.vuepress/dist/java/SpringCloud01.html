<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SpringCloud01 | Shou社</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Vue node rn flutter">
    
    <link rel="preload" href="/assets/css/0.styles.4f52b30a.css" as="style"><link rel="preload" href="/assets/js/app.5504cbb7.js" as="script"><link rel="preload" href="/assets/js/3.8dc35e94.js" as="script"><link rel="preload" href="/assets/js/2.e09e841b.js" as="script"><link rel="prefetch" href="/assets/js/10.6052d7f4.js"><link rel="prefetch" href="/assets/js/11.28851f98.js"><link rel="prefetch" href="/assets/js/12.3eec30dd.js"><link rel="prefetch" href="/assets/js/13.a8e19da8.js"><link rel="prefetch" href="/assets/js/14.52820920.js"><link rel="prefetch" href="/assets/js/15.464b113e.js"><link rel="prefetch" href="/assets/js/16.d23f24cf.js"><link rel="prefetch" href="/assets/js/17.f9a0c9c2.js"><link rel="prefetch" href="/assets/js/18.d671d4eb.js"><link rel="prefetch" href="/assets/js/19.e918bf58.js"><link rel="prefetch" href="/assets/js/20.d66a159f.js"><link rel="prefetch" href="/assets/js/21.b23c0dba.js"><link rel="prefetch" href="/assets/js/22.0c72b1a8.js"><link rel="prefetch" href="/assets/js/23.103d9662.js"><link rel="prefetch" href="/assets/js/24.d53164ae.js"><link rel="prefetch" href="/assets/js/25.411a24b9.js"><link rel="prefetch" href="/assets/js/26.6000c271.js"><link rel="prefetch" href="/assets/js/27.32e8025f.js"><link rel="prefetch" href="/assets/js/4.a8cbdbc4.js"><link rel="prefetch" href="/assets/js/5.5e5103d6.js"><link rel="prefetch" href="/assets/js/6.62306bbc.js"><link rel="prefetch" href="/assets/js/7.0aa068d6.js"><link rel="prefetch" href="/assets/js/8.a8fdfca7.js"><link rel="prefetch" href="/assets/js/9.1c280ad1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4f52b30a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo1.jpg" alt="Shou社" class="logo"> <span class="site-name can-hide">Shou社</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link">
  集成
</a></div><div class="nav-item"><a href="/nest/" class="nav-link">
  nest
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="java学习指南" class="dropdown-title"><span class="title">java学习指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="java学习指南" class="mobile-dropdown-title"><span class="title">java学习指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/SpringCloud01.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  SpringCloud01
</a></li><li class="dropdown-item"><!----> <a href="/java/SpringCloud实用篇02.html" class="nav-link">
  SpringCloud实用篇02
</a></li><li class="dropdown-item"><!----> <a href="/java/RabbitMQ.html" class="nav-link">
  RabbitMQ
</a></li><li class="dropdown-item"><!----> <a href="/java/nacos集群搭建.html" class="nav-link">
  nacos集群搭建
</a></li></ul></div></div><div class="nav-item"><a href="/social/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/HshousHe/knowledgeadmin.git" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link">
  集成
</a></div><div class="nav-item"><a href="/nest/" class="nav-link">
  nest
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="java学习指南" class="dropdown-title"><span class="title">java学习指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="java学习指南" class="mobile-dropdown-title"><span class="title">java学习指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/SpringCloud01.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  SpringCloud01
</a></li><li class="dropdown-item"><!----> <a href="/java/SpringCloud实用篇02.html" class="nav-link">
  SpringCloud实用篇02
</a></li><li class="dropdown-item"><!----> <a href="/java/RabbitMQ.html" class="nav-link">
  RabbitMQ
</a></li><li class="dropdown-item"><!----> <a href="/java/nacos集群搭建.html" class="nav-link">
  nacos集群搭建
</a></li></ul></div></div><div class="nav-item"><a href="/social/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/HshousHe/knowledgeadmin.git" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/java/SpringCloud01.html" aria-current="page" class="active sidebar-link">SpringCloud01</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_1-0-学习目标" class="sidebar-link">1.0.学习目标</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_1-1-单体架构" class="sidebar-link">1.1.单体架构</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_1-2-分布式架构" class="sidebar-link">1.2.分布式架构</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_1-3-微服务" class="sidebar-link">1.3.微服务</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_1-4-springcloud" class="sidebar-link">1.4.SpringCloud</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_1-5-总结" class="sidebar-link">1.5.总结</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_2-1-服务拆分原则" class="sidebar-link">2.1.服务拆分原则</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_2-2-服务拆分示例" class="sidebar-link">2.2.服务拆分示例</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_2-3-实现远程调用案例" class="sidebar-link">2.3.实现远程调用案例</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_2-4-提供者与消费者" class="sidebar-link">2.4.提供者与消费者</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_3-1-eureka-的结构和作用" class="sidebar-link">3.1.Eureka 的结构和作用</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_3-2-搭建-eureka-server" class="sidebar-link">3.2.搭建 eureka-server</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_3-3-服务注册" class="sidebar-link">3.3.服务注册</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_3-4-服务发现" class="sidebar-link">3.4.服务发现</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_4-1-负载均衡原理" class="sidebar-link">4.1.负载均衡原理</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_4-2-源码跟踪" class="sidebar-link">4.2.源码跟踪</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_4-3-负载均衡策略" class="sidebar-link">4.3.负载均衡策略</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_4-4-饥饿加载" class="sidebar-link">4.4.饥饿加载</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_5-1-认识和安装-nacos" class="sidebar-link">5.1.认识和安装 Nacos</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_5-2-服务注册到-nacos" class="sidebar-link">5.2.服务注册到 nacos</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_5-3-服务分级存储模型" class="sidebar-link">5.3.服务分级存储模型</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_5-4-权重配置" class="sidebar-link">5.4.权重配置</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_5-5-环境隔离" class="sidebar-link">5.5.环境隔离</a></li><li class="sidebar-sub-header"><a href="/java/SpringCloud01.html#_5-6-nacos-与-eureka-的区别" class="sidebar-link">5.6.Nacos 与 Eureka 的区别</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="springcloud01"><a href="#springcloud01" class="header-anchor">#</a> SpringCloud01</h1> <h1 id="_1-认识微服务"><a href="#_1-认识微服务" class="header-anchor">#</a> 1.认识微服务</h1> <p>随着互联网行业的发展，对服务的要求也越来越高，服务架构也从单体架构逐渐演变为现在流行的微服务架构。这些架构之间有怎样的差别呢？</p> <h2 id="_1-0-学习目标"><a href="#_1-0-学习目标" class="header-anchor">#</a> 1.0.学习目标</h2> <p>了解微服务架构的优缺点</p> <h2 id="_1-1-单体架构"><a href="#_1-1-单体架构" class="header-anchor">#</a> 1.1.单体架构</h2> <p><strong>单体架构</strong>：将业务的所有功能集中在一个项目中开发，打成一个包部署。</p> <p><img src="/assets/img/image-20210713202807818.7ca2e0e8.png" alt="image-20210713202807818">
单体架构的优缺点如下：</p> <p><strong>优点：</strong></p> <ul><li>架构简单</li> <li>部署成本低</li></ul> <p><strong>缺点：</strong></p> <ul><li>耦合度高（维护困难、升级困难）</li></ul> <h2 id="_1-2-分布式架构"><a href="#_1-2-分布式架构" class="header-anchor">#</a> 1.2.分布式架构</h2> <p><strong>分布式架构</strong>：根据业务功能对系统做拆分，每个业务功能模块作为独立项目开发，称为一个服务。</p> <p><img src="/assets/img/image-20210713203124797.ea41782e.png" alt="image-20210713203124797"></p> <p>分布式架构的优缺点：</p> <p><strong>优点：</strong></p> <ul><li>降低服务耦合</li> <li>有利于服务升级和拓展</li></ul> <p><strong>缺点：</strong></p> <ul><li>服务调用关系错综复杂</li></ul> <p>分布式架构虽然降低了服务耦合，但是服务拆分时也有很多问题需要思考：</p> <ul><li>服务拆分的粒度如何界定？</li> <li>服务之间如何调用？</li> <li>服务的调用关系如何管理？</li></ul> <p>人们需要制定一套行之有效的标准来约束分布式架构。</p> <h2 id="_1-3-微服务"><a href="#_1-3-微服务" class="header-anchor">#</a> 1.3.微服务</h2> <p>微服务的架构特征：</p> <ul><li>单一职责：微服务拆分粒度更小，每一个服务都对应唯一的业务能力，做到单一职责</li> <li>自治：团队独立、技术独立、数据独立，独立部署和交付</li> <li>面向服务：服务提供统一标准的接口，与语言和技术无关</li> <li>隔离性强：服务调用做好隔离、容错、降级，避免出现级联问题</li></ul> <p><img src="/assets/img/image-20210713203753373.bf4a4b52.png" alt="image-20210713203753373"></p> <p>微服务的上述特性其实是在给分布式架构制定一个标准，进一步降低服务之间的耦合度，提供服务的独立性和灵活性。做到高内聚，低耦合。</p> <p>因此，可以认为<strong>微服务</strong>是一种经过良好架构设计的<strong>分布式架构方案</strong> 。</p> <p>但方案该怎么落地？选用什么样的技术栈？全球的互联网公司都在积极尝试自己的微服务落地方案。</p> <p>其中在 Java 领域最引人注目的就是 SpringCloud 提供的方案了。</p> <h2 id="_1-4-springcloud"><a href="#_1-4-springcloud" class="header-anchor">#</a> 1.4.SpringCloud</h2> <p>SpringCloud 是目前国内使用最广泛的微服务框架。官网地址：https://spring.io/projects/spring-cloud。</p> <p>SpringCloud 集成了各种微服务功能组件，并基于 SpringBoot 实现了这些组件的自动装配，从而提供了良好的开箱即用体验。</p> <p>其中常见的组件包括：</p> <p><img src="/assets/img/image-20210713204155887.c2272f44.png" alt="image-20210713204155887"></p> <p>另外，SpringCloud 底层是依赖于 SpringBoot 的，并且有版本的兼容关系，如下：</p> <p><img src="/assets/img/image-20210713205003790.f2ae905c.png" alt="image-20210713205003790"></p> <p>我们课堂学习的版本是 Hoxton.SR10，因此对应的 SpringBoot 版本是 2.3.x 版本。</p> <h2 id="_1-5-总结"><a href="#_1-5-总结" class="header-anchor">#</a> 1.5.总结</h2> <ul><li><p>单体架构：简单方便，高度耦合，扩展性差，适合小型项目。例如：学生管理系统</p></li> <li><p>分布式架构：松耦合，扩展性好，但架构复杂，难度大。适合大型互联网项目，例如：京东、淘宝</p></li> <li><p>微服务：一种良好的分布式架构方案</p> <p>① 优点：拆分粒度更小、服务更独立、耦合度更低</p> <p>② 缺点：架构非常复杂，运维、监控、部署难度提高</p></li> <li><p>SpringCloud 是微服务架构的一站式解决方案，集成了各种优秀微服务功能组件</p></li></ul> <h1 id="_2-服务拆分和远程调用"><a href="#_2-服务拆分和远程调用" class="header-anchor">#</a> 2.服务拆分和远程调用</h1> <p>任何分布式架构都离不开服务的拆分，微服务也是一样。</p> <h2 id="_2-1-服务拆分原则"><a href="#_2-1-服务拆分原则" class="header-anchor">#</a> 2.1.服务拆分原则</h2> <p>这里我总结了微服务拆分时的几个原则：</p> <ul><li>不同微服务，不要重复开发相同业务</li> <li>微服务数据独立，不要访问其它微服务的数据库</li> <li>微服务可以将自己的业务暴露为接口，供其它微服务调用</li></ul> <p><img src="/assets/img/image-20210713210800950.809884ea.png" alt="image-20210713210800950"></p> <h2 id="_2-2-服务拆分示例"><a href="#_2-2-服务拆分示例" class="header-anchor">#</a> 2.2.服务拆分示例</h2> <p>以课前资料中的微服务 cloud-demo 为例，其结构如下：</p> <p><img src="/assets/img/image-20210713211009593.d4fc004c.png" alt="image-20210713211009593"></p> <p>cloud-demo：父工程，管理依赖</p> <ul><li>order-service：订单微服务，负责订单相关业务</li> <li>user-service：用户微服务，负责用户相关业务</li></ul> <p>要求：</p> <ul><li>订单微服务和用户微服务都必须有各自的数据库，相互独立</li> <li>订单服务和用户服务都对外暴露 Restful 的接口</li> <li>订单服务如果需要查询用户信息，只能调用用户服务的 Restful 接口，不能查询用户数据库</li></ul> <h3 id="_2-2-1-导入-sql-语句"><a href="#_2-2-1-导入-sql-语句" class="header-anchor">#</a> 2.2.1.导入 Sql 语句</h3> <p>首先，将课前资料提供的<code>cloud-order.sql</code>和<code>cloud-user.sql</code>导入到 mysql 中：</p> <p><img src="/assets/img/image-20210713211417049.615ba507.png" alt="image-20210713211417049"></p> <p>cloud-user 表中初始数据如下：</p> <p><img src="/assets/img/image-20210713211550169.1d17cdb7.png" alt="image-20210713211550169"></p> <p>cloud-order 表中初始数据如下：</p> <p><img src="/assets/img/image-20210713211657319.b977bf99.png" alt="image-20210713211657319"></p> <p>cloud-order 表中持有 cloud-user 表中的 id 字段。</p> <h3 id="_2-2-2-导入-demo-工程"><a href="#_2-2-2-导入-demo-工程" class="header-anchor">#</a> 2.2.2.导入 demo 工程</h3> <p>用 IDEA 导入课前资料提供的 Demo：</p> <p><img src="/assets/img/image-20210713211814094.693cf885.png" alt="image-20210713211814094"></p> <p>项目结构如下：</p> <p><img src="/assets/img/image-20210713212656887.605ea50d.png" alt="image-20210713212656887"></p> <p>导入后，会在 IDEA 右下角出现弹窗：</p> <p><img src="data:image/png;base64,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" alt="image-20210713212349272"></p> <p>点击弹窗，然后按下图选择：</p> <p><img src="/assets/img/image-20210713212336185.d099c550.png" alt="image-20210713212336185"></p> <p>会出现这样的菜单：</p> <p><img src="/assets/img/image-20210713212513324.8ebc08f6.png" alt="image-20210713212513324"></p> <p>配置下项目使用的 JDK：</p> <p><img src="/assets/img/image-20210713220736408.87d18778.png" alt="image-20210713220736408"></p> <h2 id="_2-3-实现远程调用案例"><a href="#_2-3-实现远程调用案例" class="header-anchor">#</a> 2.3.实现远程调用案例</h2> <p>在 order-service 服务中，有一个根据 id 查询订单的接口：</p> <p><img src="/assets/img/image-20210713212749575.27d16743.png" alt="image-20210713212749575"></p> <p>根据 id 查询订单，返回值是 Order 对象，如图：</p> <p><img src="/assets/img/image-20210713212901725.dccdc0e1.png" alt="image-20210713212901725"></p> <p>其中的 user 为 null</p> <p>在 user-service 中有一个根据 id 查询用户的接口：</p> <p><img src="/assets/img/image-20210713213146089.296f386c.png" alt="image-20210713213146089"></p> <p>查询的结果如图：</p> <p><img src="/assets/img/image-20210713213213075.25998742.png" alt="image-20210713213213075"></p> <h3 id="_2-3-1-案例需求"><a href="#_2-3-1-案例需求" class="header-anchor">#</a> 2.3.1.案例需求：</h3> <p>修改 order-service 中的根据 id 查询订单业务，要求在查询订单的同时，根据订单中包含的 userId 查询出用户信息，一起返回。</p> <p><img src="/assets/img/image-20210713213312278.e205f616.png" alt="image-20210713213312278"></p> <p>因此，我们需要在 order-service 中 向 user-service 发起一个 http 的请求，调用http://localhost:8081/user/{userId}这个接口。</p> <p>大概的步骤是这样的：</p> <ul><li>注册一个 RestTemplate 的实例到 Spring 容器</li> <li>修改 order-service 服务中的 OrderService 类中的 queryOrderById 方法，根据 Order 对象中的 userId 查询 User</li> <li>将查询的 User 填充到 Order 对象，一起返回</li></ul> <h3 id="_2-3-2-注册-resttemplate"><a href="#_2-3-2-注册-resttemplate" class="header-anchor">#</a> 2.3.2.注册 RestTemplate</h3> <p>首先，我们在 order-service 服务中的 OrderApplication 启动类中，注册 RestTemplate 实例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>order</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">MapperScan</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestTemplate</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">&quot;cn.itcast.order.mapper&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-3-3-实现远程调用"><a href="#_2-3-3-实现远程调用" class="header-anchor">#</a> 2.3.3.实现远程调用</h3> <p>修改 order-service 服务中的 cn.itcast.order.service 包下的 OrderService 类中的 queryOrderById 方法：</p> <p><img src="/assets/img/image-20210713213959569.dd3a1896.png" alt="image-20210713213959569"></p> <h2 id="_2-4-提供者与消费者"><a href="#_2-4-提供者与消费者" class="header-anchor">#</a> 2.4.提供者与消费者</h2> <p>在服务调用关系中，会有两个不同的角色：</p> <p><strong>服务提供者</strong>：一次业务中，被其它微服务调用的服务。（提供接口给其它微服务）</p> <p><strong>服务消费者</strong>：一次业务中，调用其它微服务的服务。（调用其它微服务提供的接口）</p> <p><img src="/assets/img/image-20210713214404481.0c321504.png" alt="image-20210713214404481"></p> <p>但是，服务提供者与服务消费者的角色并不是绝对的，而是相对于业务而言。</p> <p>如果服务 A 调用了服务 B，而服务 B 又调用了服务 C，服务 B 的角色是什么？</p> <ul><li>对于 A 调用 B 的业务而言：A 是服务消费者，B 是服务提供者</li> <li>对于 B 调用 C 的业务而言：B 是服务消费者，C 是服务提供者</li></ul> <p>因此，服务 B 既可以是服务提供者，也可以是服务消费者。</p> <h1 id="_3-eureka-注册中心"><a href="#_3-eureka-注册中心" class="header-anchor">#</a> 3.Eureka 注册中心</h1> <p>假如我们的服务提供者 user-service 部署了多个实例，如图：</p> <p><img src="/assets/img/image-20210713214925388.76b879c9.png" alt="image-20210713214925388"></p> <p>大家思考几个问题：</p> <ul><li>order-service 在发起远程调用的时候，该如何得知 user-service 实例的 ip 地址和端口？</li> <li>有多个 user-service 实例地址，order-service 调用时该如何选择？</li> <li>order-service 如何得知某个 user-service 实例是否依然健康，是不是已经宕机？</li></ul> <h2 id="_3-1-eureka-的结构和作用"><a href="#_3-1-eureka-的结构和作用" class="header-anchor">#</a> 3.1.Eureka 的结构和作用</h2> <p>这些问题都需要利用 SpringCloud 中的注册中心来解决，其中最广为人知的注册中心就是 Eureka，其结构如下：</p> <p><img src="/assets/img/image-20210713220104956.1367a471.png" alt="image-20210713220104956"></p> <p>回答之前的各个问题。</p> <p>问题 1：order-service 如何得知 user-service 实例地址？</p> <p>获取地址信息的流程如下：</p> <ul><li>user-service 服务实例启动后，将自己的信息注册到 eureka-server（Eureka 服务端）。这个叫服务注册</li> <li>eureka-server 保存服务名称到服务实例地址列表的映射关系</li> <li>order-service 根据服务名称，拉取实例地址列表。这个叫服务发现或服务拉取</li></ul> <p>问题 2：order-service 如何从多个 user-service 实例中选择具体的实例？</p> <ul><li>order-service 从实例列表中利用负载均衡算法选中一个实例地址</li> <li>向该实例地址发起远程调用</li></ul> <p>问题 3：order-service 如何得知某个 user-service 实例是否依然健康，是不是已经宕机？</p> <ul><li>user-service 会每隔一段时间（默认 30 秒）向 eureka-server 发起请求，报告自己状态，称为心跳</li> <li>当超过一定时间没有发送心跳时，eureka-server 会认为微服务实例故障，将该实例从服务列表中剔除</li> <li>order-service 拉取服务时，就能将故障实例排除了</li></ul> <blockquote><p>注意：一个微服务，既可以是服务提供者，又可以是服务消费者，因此 eureka 将服务注册、服务发现等功能统一封装到了 eureka-client 端</p></blockquote> <p>因此，接下来我们动手实践的步骤包括：</p> <p><img src="/assets/img/image-20210713220509769.580d97e3.png" alt="image-20210713220509769"></p> <h2 id="_3-2-搭建-eureka-server"><a href="#_3-2-搭建-eureka-server" class="header-anchor">#</a> 3.2.搭建 eureka-server</h2> <p>首先大家注册中心服务端：eureka-server，这必须是一个独立的微服务</p> <h3 id="_3-2-1-创建-eureka-server-服务"><a href="#_3-2-1-创建-eureka-server-服务" class="header-anchor">#</a> 3.2.1.创建 eureka-server 服务</h3> <p>在 cloud-demo 父工程下，创建一个子模块：</p> <p><img src="/assets/img/image-20210713220605881.438bd7fc.png" alt="image-20210713220605881"></p> <p>填写模块信息：</p> <p><img src="/assets/img/image-20210713220857396.9e2ff925.png" alt="image-20210713220857396"></p> <p>然后填写服务信息：</p> <p><img src="/assets/img/image-20210713221339022.3f28c642.png" alt="image-20210713221339022"></p> <h3 id="_3-2-2-引入-eureka-依赖"><a href="#_3-2-2-引入-eureka-依赖" class="header-anchor">#</a> 3.2.2.引入 eureka 依赖</h3> <p>引入 SpringCloud 为 eureka 提供的 starter 依赖：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_3-2-3-编写启动类"><a href="#_3-2-3-编写启动类" class="header-anchor">#</a> 3.2.3.编写启动类</h3> <p>给 eureka-server 服务编写一个启动类，一定要添加一个@EnableEurekaServer 注解，开启 eureka 的注册中心功能：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>eureka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>eureka<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">EnableEurekaServer</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-2-4-编写配置文件"><a href="#_3-2-4-编写配置文件" class="header-anchor">#</a> 3.2.4.编写配置文件</h3> <p>编写一个 application.yml 文件，内容如下：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
</code></pre></div><h3 id="_3-2-5-启动服务"><a href="#_3-2-5-启动服务" class="header-anchor">#</a> 3.2.5.启动服务</h3> <p>启动微服务，然后在浏览器访问：http://127.0.0.1:10086</p> <p>看到下面结果应该是成功了：</p> <p><img src="/assets/img/image-20210713222157190.1c6f2cf6.png" alt="image-20210713222157190"></p> <h2 id="_3-3-服务注册"><a href="#_3-3-服务注册" class="header-anchor">#</a> 3.3.服务注册</h2> <p>下面，我们将 user-service 注册到 eureka-server 中去。</p> <h3 id="_1-引入依赖"><a href="#_1-引入依赖" class="header-anchor">#</a> 1）引入依赖</h3> <p>在 user-service 的 pom 文件中，引入下面的 eureka-client 依赖：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_2-配置文件"><a href="#_2-配置文件" class="header-anchor">#</a> 2）配置文件</h3> <p>在 user-service 中，修改 application.yml 文件，添加服务名称、eureka 地址：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
</code></pre></div><h3 id="_3-启动多个-user-service-实例"><a href="#_3-启动多个-user-service-实例" class="header-anchor">#</a> 3）启动多个 user-service 实例</h3> <p>为了演示一个服务有多个实例的场景，我们添加一个 SpringBoot 的启动配置，再启动一个 user-service。</p> <p>首先，复制原来的 user-service 启动配置：</p> <p><img src="/assets/img/image-20210713222656562.51b65dd2.png" alt="image-20210713222656562"></p> <p>然后，在弹出的窗口中，填写信息：</p> <p><img src="/assets/img/image-20210713222757702.525d9646.png" alt="image-20210713222757702"></p> <p>现在，SpringBoot 窗口会出现两个 user-service 启动配置：</p> <p><img src="/assets/img/image-20210713222841951.4df1ed18.png" alt="image-20210713222841951"></p> <p>不过，第一个是 8081 端口，第二个是 8082 端口。</p> <p>启动两个 user-service 实例：</p> <p><img src="/assets/img/image-20210713223041491.5994e7d1.png" alt="image-20210713223041491"></p> <p>查看 eureka-server 管理页面：</p> <p><img src="/assets/img/image-20210713223150650.f4e4b411.png" alt="image-20210713223150650"></p> <h2 id="_3-4-服务发现"><a href="#_3-4-服务发现" class="header-anchor">#</a> 3.4.服务发现</h2> <p>下面，我们将 order-service 的逻辑修改：向 eureka-server 拉取 user-service 的信息，实现服务发现。</p> <h3 id="_1-引入依赖-2"><a href="#_1-引入依赖-2" class="header-anchor">#</a> 1）引入依赖</h3> <p>之前说过，服务发现、服务注册统一都封装在 eureka-client 依赖，因此这一步与服务注册时一致。</p> <p>在 order-service 的 pom 文件中，引入下面的 eureka-client 依赖：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_2-配置文件-2"><a href="#_2-配置文件-2" class="header-anchor">#</a> 2）配置文件</h3> <p>服务发现也需要知道 eureka 地址，因此第二步与服务注册一致，都是配置 eureka 信息：</p> <p>在 order-service 中，修改 application.yml 文件，添加服务名称、eureka 地址：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> orderservice
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
</code></pre></div><h3 id="_3-服务拉取和负载均衡"><a href="#_3-服务拉取和负载均衡" class="header-anchor">#</a> 3）服务拉取和负载均衡</h3> <p>最后，我们要去 eureka-server 中拉取 user-service 服务的实例列表，并且实现负载均衡。</p> <p>不过这些动作不用我们去做，只需要添加一些注解即可。</p> <p>在 order-service 的 OrderApplication 中，给 RestTemplate 这个 Bean 添加一个@LoadBalanced 注解：</p> <p><img src="/assets/img/image-20210713224049419.8f5661e9.png" alt="image-20210713224049419"></p> <p>修改 order-service 服务中的 cn.itcast.order.service 包下的 OrderService 类中的 queryOrderById 方法。修改访问的 url 路径，用服务名代替 ip、端口：</p> <p><img src="/assets/img/image-20210713224245731.e51bc0b3.png" alt="image-20210713224245731"></p> <p>spring 会自动帮助我们从 eureka-server 端，根据 userservice 这个服务名称，获取实例列表，而后完成负载均衡。</p> <h1 id="_4-ribbon-负载均衡"><a href="#_4-ribbon-负载均衡" class="header-anchor">#</a> 4.Ribbon 负载均衡</h1> <p>上一节中，我们添加了@LoadBalanced 注解，即可实现负载均衡功能，这是什么原理呢？</p> <h2 id="_4-1-负载均衡原理"><a href="#_4-1-负载均衡原理" class="header-anchor">#</a> 4.1.负载均衡原理</h2> <p>SpringCloud 底层其实是利用了一个名为 Ribbon 的组件，来实现负载均衡功能的。</p> <p><img src="/assets/img/image-20210713224517686.0c7051d4.png" alt="image-20210713224517686"></p> <p>那么我们发出的请求明明是http://userservice/user/1，怎么变成了http://localhost:8081的呢？</p> <h2 id="_4-2-源码跟踪"><a href="#_4-2-源码跟踪" class="header-anchor">#</a> 4.2.源码跟踪</h2> <p>为什么我们只输入了 service 名称就可以访问了呢？之前还要获取 ip 和端口。</p> <p>显然有人帮我们根据 service 名称，获取到了服务实例的 ip 和端口。它就是<code>LoadBalancerInterceptor</code>，这个类会在对 RestTemplate 的请求进行拦截，然后从 Eureka 根据服务 id 获取服务列表，随后利用负载均衡算法得到真实的服务地址信息，替换服务 id。</p> <p>我们进行源码跟踪：</p> <h3 id="_1-loadbalancerintercepor"><a href="#_1-loadbalancerintercepor" class="header-anchor">#</a> 1）LoadBalancerIntercepor</h3> <p><img src="/assets/img/1525620483637.60e5fa18.png" alt="1525620483637"></p> <p>可以看到这里的 intercept 方法，拦截了用户的 HttpRequest 请求，然后做了几件事：</p> <ul><li><code>request.getURI()</code>：获取请求 uri，本例中就是 http://user-service/user/8</li> <li><code>originalUri.getHost()</code>：获取 uri 路径的主机名，其实就是服务 id，<code>user-service</code></li> <li><code>this.loadBalancer.execute()</code>：处理服务 id，和用户请求。</li></ul> <p>这里的<code>this.loadBalancer</code>是<code>LoadBalancerClient</code>类型，我们继续跟入。</p> <h3 id="_2-loadbalancerclient"><a href="#_2-loadbalancerclient" class="header-anchor">#</a> 2）LoadBalancerClient</h3> <p>继续跟入 execute 方法：</p> <p><img src="/assets/img/1525620787090.d8822cdf.png" alt="1525620787090"></p> <p>代码是这样的：</p> <ul><li>getLoadBalancer(serviceId)：根据服务 id 获取 ILoadBalancer，而 ILoadBalancer 会拿着服务 id 去 eureka 中获取服务列表并保存起来。</li> <li>getServer(loadBalancer)：利用内置的负载均衡算法，从服务列表中选择一个。本例中，可以看到获取了 8082 端口的服务</li></ul> <p>放行后，再次访问并跟踪，发现获取的是 8081：</p> <p><img src="/assets/img/1525620835911.f36ce91f.png" alt="1525620835911"></p> <p>果然实现了负载均衡。</p> <h3 id="_3-负载均衡策略-irule"><a href="#_3-负载均衡策略-irule" class="header-anchor">#</a> 3）负载均衡策略 IRule</h3> <p>在刚才的代码中，可以看到获取服务使通过一个<code>getServer</code>方法来做负载均衡:</p> <p><img src="/assets/img/1525620835911.f36ce91f.png" alt="1525620835911"></p> <p>我们继续跟入：</p> <p><img src="/assets/img/1544361421671.07ef505a.png" alt="1544361421671"></p> <p>继续跟踪源码 chooseServer 方法，发现这么一段代码：</p> <p><img src="/assets/img/1525622652849.8d1b54b3.png" alt="1525622652849"></p> <p>我们看看这个 rule 是谁：</p> <p><img src="/assets/img/1525622699666.08de5bce.png" alt="1525622699666"></p> <p>这里的 rule 默认值是一个<code>RoundRobinRule</code>，看类的介绍：</p> <p><img src="/assets/img/1525622754316.e773db07.png" alt="1525622754316"></p> <p>这不就是轮询的意思嘛。</p> <p>到这里，整个负载均衡的流程我们就清楚了。</p> <h3 id="_4-总结"><a href="#_4-总结" class="header-anchor">#</a> 4）总结</h3> <p>SpringCloudRibbon 的底层采用了一个拦截器，拦截了 RestTemplate 发出的请求，对地址做了修改。用一幅图来总结一下：</p> <p><img src="/assets/img/image-20210713224724673.a3414a08.png" alt="image-20210713224724673"></p> <p>基本流程如下：</p> <ul><li>拦截我们的 RestTemplate 请求http://userservice/user/1</li> <li>RibbonLoadBalancerClient 会从请求 url 中获取服务名称，也就是 user-service</li> <li>DynamicServerListLoadBalancer 根据 user-service 到 eureka 拉取服务列表</li> <li>eureka 返回列表，localhost:8081、localhost:8082</li> <li>IRule 利用内置负载均衡规则，从列表中选择一个，例如 localhost:8081</li> <li>RibbonLoadBalancerClient 修改请求地址，用 localhost:8081 替代 userservice，得到http://localhost:8081/user/1，发起真实请求</li></ul> <h2 id="_4-3-负载均衡策略"><a href="#_4-3-负载均衡策略" class="header-anchor">#</a> 4.3.负载均衡策略</h2> <h3 id="_4-3-1-负载均衡策略"><a href="#_4-3-1-负载均衡策略" class="header-anchor">#</a> 4.3.1.负载均衡策略</h3> <p>负载均衡的规则都定义在 IRule 接口中，而 IRule 有很多不同的实现类：</p> <p><img src="/assets/img/image-20210713225653000.4c64b5c6.png" alt="image-20210713225653000"></p> <p>不同规则的含义如下：</p> <table><thead><tr><th><strong>内置负载均衡规则类</strong></th> <th><strong>规则描述</strong></th></tr></thead> <tbody><tr><td>RoundRobinRule</td> <td>简单轮询服务列表来选择服务器。它是 Ribbon 默认的负载均衡规则。</td></tr> <tr><td>AvailabilityFilteringRule</td> <td>对以下两种服务器进行忽略： （1）在默认情况下，这台服务器如果 3 次连接失败，这台服务器就会被设置为“短路”状态。短路状态将持续 30 秒，如果再次连接失败，短路的持续时间就会几何级地增加。 （2）并发数过高的服务器。如果一个服务器的并发连接数过高，配置了 AvailabilityFilteringRule 规则的客户端也会将其忽略。并发连接数的上限，可以由客户端的<code>&lt;clientName&gt;.&lt;clientConfigNameSpace&gt;</code>.ActiveConnectionsLimit 属性进行配置。</td></tr> <tr><td>WeightedResponseTimeRule</td> <td>为每一个服务器赋予一个权重值。服务器响应时间越长，这个服务器的权重就越小。这个规则会随机选择服务器，这个权重值会影响服务器的选择。</td></tr> <tr><td><strong>ZoneAvoidanceRule</strong></td> <td>以区域可用的服务器为基础进行服务器的选择。使用 Zone 对服务器进行分类，这个 Zone 可以理解为一个机房、一个机架等。而后再对 Zone 内的多个服务做轮询。</td></tr> <tr><td>BestAvailableRule</td> <td>忽略那些短路的服务器，并选择并发数较低的服务器。</td></tr> <tr><td>RandomRule</td> <td>随机选择一个可用的服务器。</td></tr> <tr><td>RetryRule</td> <td>重试机制的选择逻辑</td></tr></tbody></table> <p>默认的实现就是 ZoneAvoidanceRule，是一种轮询方案</p> <h3 id="_4-3-2-自定义负载均衡策略"><a href="#_4-3-2-自定义负载均衡策略" class="header-anchor">#</a> 4.3.2.自定义负载均衡策略</h3> <p>通过定义 IRule 实现可以修改负载均衡规则，有两种方式：</p> <ol><li>代码方式：在 order-service 中的 OrderApplication 类中，定义一个新的 IRule：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">IRule</span> <span class="token function">randomRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RandomRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>配置文件方式：在 order-service 的 application.yml 文件中，添加新的配置也可以修改规则：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">userservice</span><span class="token punctuation">:</span> <span class="token comment"># 给某个微服务配置负载均衡规则，这里是userservice服务</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.RandomRule <span class="token comment"># 负载均衡规则</span>
</code></pre></div><blockquote><p><strong>注意</strong>，一般用默认的负载均衡规则，不做修改。</p></blockquote> <h2 id="_4-4-饥饿加载"><a href="#_4-4-饥饿加载" class="header-anchor">#</a> 4.4.饥饿加载</h2> <p>Ribbon 默认是采用懒加载，即第一次访问时才会去创建 LoadBalanceClient，请求时间会很长。</p> <p>而饥饿加载则会在项目启动时创建，降低第一次访问的耗时，通过下面配置开启饥饿加载：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">eager-load</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">clients</span><span class="token punctuation">:</span> userservice
</code></pre></div><h1 id="_5-nacos-注册中心"><a href="#_5-nacos-注册中心" class="header-anchor">#</a> 5.Nacos 注册中心</h1> <p>国内公司一般都推崇阿里巴巴的技术，比如注册中心，SpringCloudAlibaba 也推出了一个名为 Nacos 的注册中心。</p> <h2 id="_5-1-认识和安装-nacos"><a href="#_5-1-认识和安装-nacos" class="header-anchor">#</a> 5.1.认识和安装 Nacos</h2> <p><a href="https://nacos.io/" target="_blank" rel="noopener noreferrer">Nacos<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是阿里巴巴的产品，现在是<a href="https://spring.io/projects/spring-cloud" target="_blank" rel="noopener noreferrer">SpringCloud<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中的一个组件。相比<a href="https://github.com/Netflix/eureka" target="_blank" rel="noopener noreferrer">Eureka<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>功能更加丰富，在国内受欢迎程度较高。</p> <p><img src="/assets/img/image-20210713230444308.142c8955.png" alt="image-20210713230444308"></p> <p>安装方式可以参考课前资料《Nacos 安装指南.md》</p> <h2 id="_5-2-服务注册到-nacos"><a href="#_5-2-服务注册到-nacos" class="header-anchor">#</a> 5.2.服务注册到 nacos</h2> <p>Nacos 是 SpringCloudAlibaba 的组件，而 SpringCloudAlibaba 也遵循 SpringCloud 中定义的服务注册、服务发现规范。因此使用 Nacos 和使用 Eureka 对于微服务来说，并没有太大区别。</p> <p>主要差异在于：</p> <ul><li>依赖不同</li> <li>服务地址不同</li></ul> <h3 id="_1-引入依赖-3"><a href="#_1-引入依赖-3" class="header-anchor">#</a> 1）引入依赖</h3> <p>在 cloud-demo 父工程的 pom 文件中的<code>&lt;dependencyManagement&gt;</code>中引入 SpringCloudAlibaba 的依赖：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后在 user-service 和 order-service 中的 pom 文件中引入 nacos-discovery 依赖：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><blockquote><p><strong>注意</strong>：不要忘了注释掉 eureka 的依赖。</p></blockquote> <h3 id="_2-配置-nacos-地址"><a href="#_2-配置-nacos-地址" class="header-anchor">#</a> 2）配置 nacos 地址</h3> <p>在 user-service 和 order-service 的 application.yml 中添加 nacos 地址：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre></div><blockquote><p><strong>注意</strong>：不要忘了注释掉 eureka 的地址</p></blockquote> <h3 id="_3-重启"><a href="#_3-重启" class="header-anchor">#</a> 3）重启</h3> <p>重启微服务后，登录 nacos 管理页面，可以看到微服务信息：</p> <p><img src="/assets/img/image-20210713231439607.eafb858e.png" alt="image-20210713231439607"></p> <h2 id="_5-3-服务分级存储模型"><a href="#_5-3-服务分级存储模型" class="header-anchor">#</a> 5.3.服务分级存储模型</h2> <p>一个<strong>服务</strong>可以有多个<strong>实例</strong>，例如我们的 user-service，可以有:</p> <ul><li>127.0.0.1:8081</li> <li>127.0.0.1:8082</li> <li>127.0.0.1:8083</li></ul> <p>假如这些实例分布于全国各地的不同机房，例如：</p> <ul><li>127.0.0.1:8081，在上海机房</li> <li>127.0.0.1:8082，在上海机房</li> <li>127.0.0.1:8083，在杭州机房</li></ul> <p>Nacos 就将同一机房内的实例 划分为一个<strong>集群</strong>。</p> <p>也就是说，user-service 是服务，一个服务可以包含多个集群，如杭州、上海，每个集群下可以有多个实例，形成分级模型，如图：</p> <p><img src="/assets/img/image-20210713232522531.0c1c87e7.png" alt="image-20210713232522531"></p> <p>微服务互相访问时，应该尽可能访问同集群实例，因为本地访问速度更快。当本集群内不可用时，才访问其它集群。例如：</p> <p><img src="/assets/img/image-20210713232658928.9f26138f.png" alt="image-20210713232658928"></p> <p>杭州机房内的 order-service 应该优先访问同机房的 user-service。</p> <h3 id="_5-3-1-给-user-service-配置集群"><a href="#_5-3-1-给-user-service-配置集群" class="header-anchor">#</a> 5.3.1.给 user-service 配置集群</h3> <p>修改 user-service 的 application.yml 文件，添加集群配置：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> HZ <span class="token comment"># 集群名称</span>
</code></pre></div><p>重启两个 user-service 实例后，我们可以在 nacos 控制台看到下面结果：</p> <p><img src="/assets/img/image-20210713232916215.f7fa2928.png" alt="image-20210713232916215"></p> <p>我们再次复制一个 user-service 启动配置，添加属性：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>-Dserver.port<span class="token operator">=</span><span class="token number">8083</span> -Dspring.cloud.nacos.discovery.cluster-name<span class="token operator">=</span>SH
</code></pre></div><p>配置如图所示：</p> <p><img src="/assets/img/image-20210713233528982.26978d78.png" alt="image-20210713233528982"></p> <p>启动 UserApplication3 后再次查看 nacos 控制台：</p> <p><img src="/assets/img/image-20210713233727923.74a4c70a.png" alt="image-20210713233727923"></p> <h3 id="_5-3-2-同集群优先的负载均衡"><a href="#_5-3-2-同集群优先的负载均衡" class="header-anchor">#</a> 5.3.2.同集群优先的负载均衡</h3> <p>默认的<code>ZoneAvoidanceRule</code>并不能实现根据同集群优先来实现负载均衡。</p> <p>因此 Nacos 中提供了一个<code>NacosRule</code>的实现，可以优先从同集群中挑选实例。</p> <p>1）给 order-service 配置集群信息</p> <p>修改 order-service 的 application.yml 文件，添加集群配置：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
        cluster-name: HZ <span class="token comment"># 集群名称</span>
</code></pre></div><p>2）修改负载均衡规则</p> <p>修改 order-service 的 application.yml 文件，修改负载均衡规则：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">userservice</span><span class="token punctuation">:</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.alibaba.cloud.nacos.ribbon.NacosRule <span class="token comment"># 负载均衡规则</span>
</code></pre></div><h2 id="_5-4-权重配置"><a href="#_5-4-权重配置" class="header-anchor">#</a> 5.4.权重配置</h2> <p>实际部署中会出现这样的场景：</p> <p>服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求。</p> <p>但默认情况下 NacosRule 是同集群内随机挑选，不会考虑机器的性能问题。</p> <p>因此，Nacos 提供了权重配置来控制访问频率，权重越大则访问频率越高。</p> <p>在 nacos 控制台，找到 user-service 的实例列表，点击编辑，即可修改权重：</p> <p><img src="/assets/img/image-20210713235133225.4dd758c0.png" alt="image-20210713235133225"></p> <p>在弹出的编辑窗口，修改权重：</p> <p><img src="/assets/img/image-20210713235235219.18b215fa.png" alt="image-20210713235235219"></p> <blockquote><p><strong>注意</strong>：如果权重修改为 0，则该实例永远不会被访问</p></blockquote> <h2 id="_5-5-环境隔离"><a href="#_5-5-环境隔离" class="header-anchor">#</a> 5.5.环境隔离</h2> <p>Nacos 提供了 namespace 来实现环境隔离功能。</p> <ul><li>nacos 中可以有多个 namespace</li> <li>namespace 下可以有 group、service 等</li> <li>不同 namespace 之间相互隔离，例如不同 namespace 的服务互相不可见</li></ul> <p><img src="/assets/img/image-20210714000101516.382dff09.png" alt="image-20210714000101516"></p> <h3 id="_5-5-1-创建-namespace"><a href="#_5-5-1-创建-namespace" class="header-anchor">#</a> 5.5.1.创建 namespace</h3> <p>默认情况下，所有 service、data、group 都在同一个 namespace，名为 public：</p> <p><img src="/assets/img/image-20210714000414781.158a77ed.png" alt="image-20210714000414781"></p> <p>我们可以点击页面新增按钮，添加一个 namespace：</p> <p><img src="/assets/img/image-20210714000440143.696641e9.png" alt="image-20210714000440143"></p> <p>然后，填写表单：</p> <p><img src="/assets/img/image-20210714000505928.95069944.png" alt="image-20210714000505928"></p> <p>就能在页面看到一个新的 namespace：</p> <p><img src="/assets/img/image-20210714000522913.42c42c38.png" alt="image-20210714000522913"></p> <h3 id="_5-5-2-给微服务配置-namespace"><a href="#_5-5-2-给微服务配置-namespace" class="header-anchor">#</a> 5.5.2.给微服务配置 namespace</h3> <p>给微服务配置 namespace 只能通过修改配置来实现。</p> <p>例如，修改 order-service 的 application.yml 文件：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> HZ
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 492a7d5d<span class="token punctuation">-</span>237b<span class="token punctuation">-</span>46a1<span class="token punctuation">-</span>a99a<span class="token punctuation">-</span>fa8e98e4b0f9 <span class="token comment"># 命名空间，填ID</span>
</code></pre></div><p>重启 order-service 后，访问控制台，可以看到下面的结果：</p> <p><img src="/assets/img/image-20210714000830703.e601f03b.png" alt="image-20210714000830703"></p> <p><img src="/assets/img/image-20210714000837140.e7783d8d.png" alt="image-20210714000837140"></p> <p>此时访问 order-service，因为 namespace 不同，会导致找不到 userservice，控制台会报错：</p> <p><img src="/assets/img/image-20210714000941256.1252aee0.png" alt="image-20210714000941256"></p> <h2 id="_5-6-nacos-与-eureka-的区别"><a href="#_5-6-nacos-与-eureka-的区别" class="header-anchor">#</a> 5.6.Nacos 与 Eureka 的区别</h2> <p>Nacos 的服务实例分为两种 l 类型：</p> <ul><li><p>临时实例：如果实例宕机超过一定时间，会从服务列表剔除，默认的类型。</p></li> <li><p>非临时实例：如果实例宕机，不会从服务列表剔除，也可以叫永久实例。</p></li></ul> <p>配置一个服务实例为永久实例：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">ephemeral</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 设置为非临时实例</span>
</code></pre></div><p>Nacos 和 Eureka 整体结构类似，服务注册、服务拉取、心跳等待，但是也存在一些差异：</p> <p><img src="/assets/img/image-20210714001728017.98fc233f.png" alt="image-20210714001728017"></p> <ul><li><p>Nacos 与 eureka 的共同点</p> <ul><li>都支持服务注册和服务拉取</li> <li>都支持服务提供者心跳方式做健康检测</li></ul></li> <li><p>Nacos 与 Eureka 的区别</p> <ul><li>Nacos 支持服务端主动检测提供者状态：临时实例采用心跳模式，非临时实例采用主动检测模式</li> <li>临时实例心跳不正常会被剔除，非临时实例则不会被剔除</li> <li>Nacos 支持服务列表变更的消息推送模式，服务列表更新更及时</li> <li>Nacos 集群默认采用 AP 方式，当集群中存在非临时实例时，采用 CP 模式；Eureka 采用 AP 方式</li></ul></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5504cbb7.js" defer></script><script src="/assets/js/3.8dc35e94.js" defer></script><script src="/assets/js/2.e09e841b.js" defer></script>
  </body>
</html>
